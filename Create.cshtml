@using WebMatrix.Data
@{
    var db = Database.Open("BoardGame");

    // Get existing families and themes
    var familyList = db.Query("SELECT Family FROM GameFamily ORDER BY Family");
    var themeList = db.Query("SELECT ThemeID, ThemeName FROM Theme ORDER BY ThemeName");

    string message = "";
    bool isSuccess = false;

    if (IsPost)
    {
        // Read values from the form
        var name = Request["Name"];
        var description = Request["Description"];
        var year = Request["YearPublished"];   // from <input type="date">
        var minPlayers = Request["MinPlayers"];
        var maxPlayers = Request["MaxPlayers"];
        var family = Request["Family"];
        var imagePath = Request["ImagePath"];
        var selectedThemeId = Request["ThemeID"];
        var newThemeName = Request["NewThemeName"];

        if (String.IsNullOrWhiteSpace(name) || String.IsNullOrWhiteSpace(description))
        {
            message = "Name and Description are required.";
        }
        else
        {
            // Get a new unique BGGId
            var newIdObj = db.QueryValue("SELECT ISNULL(MAX(BGGId), 0) + 1 FROM BoardGame");
            int newBGGId = Convert.ToInt32(newIdObj);

            // Insert the game
            db.Execute(@"
        INSERT INTO BoardGame
        (BGGId, Name, Description, YearPublished, MinPlayers, MaxPlayers, Family, ImagePath)
        VALUES
        (@0,   @1,   @2,          @3,           @4,         @5,         @6,     @7)",
                newBGGId,
                name,
                description,
                year,
                minPlayers,
                maxPlayers,
                family,
                imagePath
            );

            // ----- Theme logic -----
            string themeIdToUse = null;

            if (!String.IsNullOrWhiteSpace(newThemeName))
            {
                // Check if this theme name already exists
                var existingId = db.QueryValue(
                    "SELECT ThemeID FROM Theme WHERE ThemeName = @0",
                    newThemeName
                );

                if (existingId != null)
                {
                    themeIdToUse = existingId.ToString();
                }
                else
                {
                    // Simple approach: use the theme name itself as the ID
                    var newThemeId = newThemeName.Trim();
                    db.Execute(
                        "INSERT INTO Theme (ThemeID, ThemeName) VALUES (@0, @1)",
                        newThemeId,
                        newThemeName.Trim()
                    );
                    themeIdToUse = newThemeId;
                }
            }
            else if (!String.IsNullOrWhiteSpace(selectedThemeId))
            {
                themeIdToUse = selectedThemeId;
            }

            if (!String.IsNullOrWhiteSpace(themeIdToUse))
            {
                db.Execute(
                    "INSERT INTO GameInThemes (BGGId, ThemeID) VALUES (@0, @1)",
                    newBGGId,
                    themeIdToUse
                );
            }

            isSuccess = true;
            message = "Game created successfully.";

            // Redirect to details page for the new game
            Response.Redirect("/Home/Details?BGGId=" + newBGGId);
        }
    }
}

<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Create Game</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
          rel="stylesheet" />
</head>
<body>
    <div class="container py-4">
        <a href="/Home/Index" class="btn btn-outline-secondary mb-3">&laquo; Back</a>

        <h2 class="mb-3 text-primary fw-bold text-center">Add New Board Game</h2>

        @if (!String.IsNullOrEmpty(message))
        {
            <div class="alert @(isSuccess ? "alert-success" : "alert-danger")">
                @message
            </div>
        }

        <div class="card shadow-sm p-4">
            <form method="post" action="/Home/Create">
                <div class="mb-3">
                    <label class="form-label" for="Name">Game Name</label>
                    <input type="text" name="Name" id="Name" class="form-control" required />
                </div>

                <div class="mb-3">
                    <label class="form-label" for="Description">Description</label>
                    <textarea name="Description" id="Description" class="form-control"
                              rows="3" required></textarea>
                </div>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label" for="YearPublished">Year Published</label>
                        <input type="date" name="YearPublished" id="YearPublished"
                               class="form-control" />
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label" for="MinPlayers">Min Players</label>
                        <input type="number" name="MinPlayers" id="MinPlayers"
                               class="form-control" min="1" />
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label" for="MaxPlayers">Max Players</label>
                        <input type="number" name="MaxPlayers" id="MaxPlayers"
                               class="form-control" min="1" />
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label" for="ImagePath">Image Path</label>
                    <input type="text" name="ImagePath" id="ImagePath"
                           class="form-control" placeholder="/Images/game.jpg or URL" />
                </div>
                <div class="mb-3">
                    <label class="form-label" for="Family">Game Family</label>
                    <select name="Family" id="Family" class="form-select">
                        <option value="">-- Select a family --</option>
                        @foreach (var fam in familyList)
                        {
                            <option value="@fam.Family">@fam.Family</option>
                        }
                    </select>
                </div>
                <hr />
                <h5 class="text-secondary">Game Theme</h5>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label" for="ThemeID">Existing Theme</label>
                        <select name="ThemeID" id="ThemeID" class="form-select">
                            <option value="">--  Select theme --</option>
                            @foreach (var t in themeList)
                            {
                                <option value="@t.ThemeID">@t.ThemeName</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label" for="NewThemeName">Add new Theme</label>
                        <input type="text" name="NewThemeName" id="NewThemeName"
                               class="form-control" placeholder="Enter new theme name" />
                    </div>
                </div>

                <button type="submit" class="btn btn-success mt-2">Save Game</button>
            </form>
        </div>
    </div>
</body>
</html>
