@using WebMatrix.Data
@{
    var db = Database.Open("BoardGame");
    var id = Request.QueryString["BGGId"];

    if (String.IsNullOrEmpty(id))
    {
        <div class="alert alert-danger text-center mt-5">Invalid Game ID.</div>
        return;
    }

    // --- Fetch main game details ---
    var game = db.QuerySingle("SELECT * FROM [BoardGame] WHERE [BGGId] = @0", id);
    if (game == null)
    {
        <div class="alert alert-warning text-center mt-5">Game not found.</div>
        return;
    }

    // --- Try to get ratings if table exists ---
    dynamic ratings = new List<dynamic>();
    double avgRating = 0;
    int reviewCount = 0;

    try
    {
        ratings = db.Query("SELECT * FROM [GameRating] WHERE [BGGId] = @0", id);

        if (ratings.Count() > 0)
        {
            var validRatings = new List<double>();

            foreach (var r in ratings)
            {
                if (r.Rating != null)
                {
                    double value;
                    if (double.TryParse(r.Rating.ToString(), out value))
                    {
                        validRatings.Add(value);
                    }
                }
            }

            if (validRatings.Count > 0)
            {
                avgRating = validRatings.Average();
                reviewCount = validRatings.Count;
            }
        }
    }
    catch
    {
           // Safe fallback if GameRating table doesn't exist
        ratings = new List<dynamic>();
    }

    // --- Related games from same Family ---
    var related = db.Query(
        "SELECT TOP 6 [BGGId], [Name], [ImagePath], [YearPublished] " +
        "FROM [BoardGame] WHERE [Family] = @0 AND [BGGId] <> @1 ORDER BY NEWID()",
        game.Family, id);
}
<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <title>@game.Name – Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body>
    <div class="container py-4">
        <a href="/Home/Index" class="btn btn-outline-secondary mb-3">&laquo; Back to List</a>

    <!--  Game Details Card -->
        <div class="card shadow-lg mb-4">
            @if (!String.IsNullOrWhiteSpace(game.ImagePath))
            {
                <img src="@game.ImagePath" class="card-img-top" alt="@game.Name image"
                     style="height:400px;object-fit:cover;" />
            }
            <div class="card-body">
                <h3 class="card-title text-primary fw-bold">@game.Name</h3>
                <p class="card-text"><strong>Family:</strong> @game.Family</p>
                <p class="card-text"><strong>Players:</strong> @game.MinPlayers – @game.MaxPlayers</p>
                <p class="card-text"><strong>Year Published:</strong> @game.YearPublished</p>
                <p class="card-text"><strong>Description:</strong><br />@game.Description</p>

                <!-- ⭐ Ratings Section -->
                @if (reviewCount > 0)
                {
                    <hr />
                    <h5 class="text-success mb-3">⭐ Ratings & Reviews</h5>
                    <p><strong>Average Rating:</strong> @avgRating.ToString("0.0") / 5</p>
                    <p><strong>Number of Reviews:</strong> @reviewCount</p>

                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead class="table-light">
                                <tr><th>User</th><th>Rating</th><th>Comment</th></tr>
                            </thead>
                            <tbody>
                                @foreach (var r in ratings)
                                {
                                    <tr>
                                        <td>@r.UserName</td>
                                        <td>@r.Rating</td>
                                        <td>@r.Comment</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <p class="text-muted fst-italic">No ratings available for this game yet.</p>
                }
            </div>
        </div>

        <!-- Related Games  -->
            <div class="mb-5">
                <h4 class="text-center text-secondary fw-bold mb-3">Related Games</h4>

                <div id="relatedCarousel" class="carousel slide" data-bs-ride="carousel">
                    <div class="carousel-inner">
                        @{
                            var index = 0;
                            foreach (var rel in related)
                            {
                                <div class="carousel-item @(index == 0 ? "active" : "")">
                                    <div class="card text-center mx-auto" style="width:20rem;">
                                        @if (!String.IsNullOrWhiteSpace(rel.ImagePath))
                                        {
                                            <img src="@rel.ImagePath" class="card-img-top" alt="@rel.Name"
                                                 style="height:200px;object-fit:cover;" />
                                        }
                                        <div class="card-body">
                                            <h6 class="card-title">@rel.Name</h6>
                                            <p class="text-muted small mb-1">Year: @rel.YearPublished</p>
                                            <a href="/Home/Details?BGGId=@rel.BGGId"
                                               class="btn btn-sm btn-outline-primary">View</a>
                                        </div>
                                    </div>
                                </div>
                                index++;
                            }
                        }
                    </div>

                    <button class="carousel-control-prev" type="button"
                            data-bs-target="#relatedCarousel" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next" type="button"
                            data-bs-target="#relatedCarousel" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Next</span>
                    </button>
                </div>
            </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
