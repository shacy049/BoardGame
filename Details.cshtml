@using WebMatrix.Data
@{
    var db = Database.Open("BoardGame");
    var id = Request.QueryString["BGGId"];

    if (String.IsNullOrEmpty(id))
    {
        <div class="alert alert-danger text-center mt-5">Invalid Game ID.</div>
        return;
    }

    // --- Fetch main game details ---
    var game = db.QuerySingle("SELECT * FROM [BoardGame] WHERE [BGGId] = @0", id);
    if (game == null)
    {
        <div class="alert alert-warning text-center mt-5">Game not found.</div>
        return;
    }

    // --- Try to get ratings if table exists ---
    dynamic ratings = new List<dynamic>();
    double avgRating = 0;
    int reviewCount = 0;

    try
    {
        ratings = db.Query("SELECT * FROM [GameRating] WHERE [BGGId] = @0", id);

        if (ratings.Count() > 0)
        {
            var validRatings = new List<double>();

            foreach (var r in ratings)
            {
                if (r.Rating != null)
                {
                    double value;
                    if (double.TryParse(r.Rating.ToString(), out value))
                    {
                        validRatings.Add(value);
                    }
                }
            }

            if (validRatings.Count > 0)
            {
                avgRating = validRatings.Average();
                reviewCount = validRatings.Count;
            }
        }
    }
    catch
    {
           // Safe fallback if GameRating table doesn't exist
        ratings = new List<dynamic>();
    }

    // --- Related games from same Family ---
    var related = db.Query(
        "SELECT TOP 6 [BGGId], [Name], [ImagePath], [YearPublished] " +
        "FROM [BoardGame] WHERE [Family] = @0 AND [BGGId] <> @1 ORDER BY NEWID()",
        game.Family, id);
}
<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <title>@game.Name â€“ Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body>
    <div class="container py-4">
        <a href="/Home/Index" class="btn btn-outline-secondary mb-3">&laquo; Back to List</a>
