@using WebMatrix.Data
@{
    var db = Database.Open("BoardGame");

    var searchText = Request["searchText"] ?? "";
    var family = Request["family"] ?? "";
    var viewMode = Request["view"] ?? "table"; // default view

    // Get families for dropdown
    var familySql = "SELECT DISTINCT [Family] FROM [BoardGame] WHERE [Family] IS NOT NULL AND [Family] <> '' ORDER BY [Family]";
    var families = db.Query(familySql);

    // Base query
    var gameSql = "SELECT [BGGId], [Name], [YearPublished], [ImagePath], [Family], [MinPlayers], [MaxPlayers] FROM [BoardGame] WHERE 1=1";
    var parameters = new List<object>();

    // --- Search filter ---
    if (!String.IsNullOrWhiteSpace(searchText))
    {
        gameSql += " AND [Name] LIKE @" + parameters.Count;
        parameters.Add("%" + searchText + "%");
    }

      // --- Family filter ---
    if (!String.IsNullOrWhiteSpace(family))
    {
        gameSql += " AND [Family] = @" + parameters.Count;
        parameters.Add(family);
    }

    gameSql += " ORDER BY [Name]";
    var games = db.Query(gameSql, parameters.ToArray());
}

<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Board Games</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body>
    <div class="container py-4">
        <h2 class="text-center mb-4 text-primary fw-bold">ðŸŽ² Board Game Collection</h2>

        <!-- Search and Filter -->
        <form method="get" class="row g-2 mb-4 justify-content-center">
            <div class="col-md-4">
                <input type="text" name="searchText" value="@searchText" class="form-control" placeholder="Search by game name..." />
            </div>
            <div class="col-md-3">
                <select name="family" class="form-select">
                    <option value="">-- All --</option>
                    @foreach (var f in families)
                    {
                        var fam = (string)f.Family;
                        <option value="@fam" @(fam == family ? "selected" : "")>@fam</option>
                    }
                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">Search</button>
            </div>
        </form>

         <!-- View Mode Toggle -->
        <div class="text-center mb-3">
            <a href="?view=table&searchText=@searchText&family=@family"
               class="btn btn-outline-dark me-2 @(viewMode=="table"?"active":"")">Table View</a>
            <a href="?view=card&searchText=@searchText&family=@family"
               class="btn btn-outline-success @(viewMode=="card"?"active":"")">Card View</a>
        </div>

        @if (!games.Any())
        {
            <div class="alert alert-warning text-center">
                No board games match your search. Try a different name or family.
            </div>
        }
        else if (viewMode == "card")
        {
            <!-- Card View -->
            <div class="row row-cols-1 row-cols-md-3 g-4">
                @foreach (var g in games)
                {
                    <div class="col">
                        <div class="card h-100 shadow-sm">
                            @if (!String.IsNullOrWhiteSpace(g.ImagePath))
                            {
                                <img src="@g.ImagePath" class="card-img-top" alt="@g.Name image" style="height:200px;object-fit:cover;" />
                            }
                            <div class="card-body">
                                <h5 class="card-title">@g.Name</h5>
                                <p class="card-text small mb-1"><strong>Year:</strong> @(g.YearPublished ?? "N/A")</p>
                                <p class="card-text small"><strong>Family:</strong> @g.Family</p>
                                <p class="card-text small"><strong>Players:</strong> @g.MinPlayers â€“ @g.MaxPlayers</p>
                                <a href="/Home/Details?BGGId=@g.BGGId" class="btn btn-outline-primary w-100">View Details</a>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <!--  Table View -->
            <table class="table table-bordered table-hover align-middle">
                <thead class="table-dark text-center">
                    <tr>
                        <th>Image</th>
                        <th>Name</th>
                        <th>Family</th>
                        <th>Players</th>
                        <th>Year</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var g in games)
                    {
                        <tr>
                            <td style="width:100px;">
                                @if (!String.IsNullOrWhiteSpace(g.ImagePath))
                                {
                                    <img src="@g.ImagePath" alt="@g.Name" style="height:60px;width:100%;object-fit:cover;" />
                                }
                            </td>
                            <td>@g.Name</td>
                            <td>@g.Family</td>
                            <td class="text-center">@g.MinPlayers â€“ @g.MaxPlayers</td>
                            <td>@(g.YearPublished ?? "N/A")</td>
                            <td class="text-center">
                                <a href="/Home/Details?BGGId=@g.BGGId" class="btn btn-sm btn-outline-primary">Details</a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
    </div>
</body>
</html>